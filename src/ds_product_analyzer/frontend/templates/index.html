{% extends "base.html" %}
{% block title %}Dashboard — DS Product Analyzer{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-bold">Trending Products</h1>
        <p class="text-gray-400 text-sm mt-1">
            {% if products %}
                {% set confirmed = products | selectattr('is_confirmed') | list %}
                {% set social    = products | rejectattr('is_confirmed') | list %}
                {{ total_products }} products tracked · {{ confirmed | length }} confirmed · {{ social | length }} social signals
            {% else %}
                {{ total_products }} products tracked
            {% endif %}
            {% if last_updated %}
                · Last updated {{ last_updated.strftime('%b %d, %H:%M UTC') }}
            {% else %}
                · No data collected yet
            {% endif %}
        </p>
    </div>
    <div class="flex items-center gap-3">
        <!-- Category filter -->
        <form method="get" action="/" class="flex items-center gap-2">
            <select name="category"
                    onchange="this.form.submit()"
                    class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>
                    {{ cat | replace('-', ' ') | title }}
                </option>
                {% endfor %}
            </select>
        </form>
        <!-- Manual trigger -->
        <button onclick="triggerCollection()"
                id="triggerBtn"
                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
            Collect Now
        </button>
    </div>
</div>

{% if products %}
{% set confirmed = products | selectattr('is_confirmed') | list %}
{% set social    = products | rejectattr('is_confirmed') | list %}

<!-- Section 1: Confirmed Products (collapsible, open by default) -->
<details class="mb-2" open>
    <summary class="cursor-pointer text-gray-300 text-sm font-medium mb-2 select-none">
        Confirmed Products ({{ confirmed | length }})
    </summary>
    {% if confirmed %}
    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
        <table class="w-full text-sm table-fixed">
            <thead>
                <tr class="border-b border-gray-800 text-gray-400 text-xs uppercase tracking-wider">
                    <th class="w-8  px-2 py-3 text-left">#</th>
                    <th class="      px-2 py-3 text-left">Product</th>
                    <th class="w-24 px-2 py-3 text-left">Category</th>
                    <th class="w-16 px-2 py-3 text-center">Price</th>
                    <th class="w-14 px-2 py-3 text-center">Score</th>
                    <th class="w-16 px-2 py-3 text-center">Trend</th>
                    <th class="w-12 px-2 py-3 text-center" title="Search acceleration">Srch</th>
                    <th class="w-12 px-2 py-3 text-center">Social</th>
                    <th class="w-12 px-2 py-3 text-center" title="Amazon BSR acceleration">Amzn</th>
                    <th class="w-14 px-2 py-3 text-center" title="Price fit score">P.Fit</th>
                    <th class="w-12 px-2 py-3 text-center" title="Sentiment score">Sent</th>
                    <th class="w-12 px-2 py-3 text-center" title="Purchase intent">Intent</th>
                    <th class="w-10 px-2 py-3 text-center" title="Platform source count">Src</th>
                    <th class="w-14 px-2 py-3 text-right" title="First seen date">Seen</th>
                </tr>
            </thead>
            <tbody>
                {% for p in confirmed %}
                <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition-colors">
                    <td class="px-2 py-3 text-gray-500 font-mono">{{ loop.index }}</td>
                    <td class="px-2 py-3 min-w-0">
                        <a href="/products/{{ p.id }}" class="text-blue-400 hover:text-blue-300 font-medium line-clamp-2">
                            {{ p.name | title }}
                        </a>
                    </td>
                    <td class="px-2 py-3">
                        <span class="text-gray-400 text-xs bg-gray-800 px-1.5 py-0.5 rounded block truncate">
                            {{ p.category | replace('-', ' ') | title }}
                        </span>
                    </td>
                    <td class="px-2 py-3 text-center text-gray-300 text-xs">
                        {% if p.price_low and p.price_high %}
                            ${{ '%.0f' | format(p.price_low) }}–${{ '%.0f' | format(p.price_high) }}
                        {% elif p.price_low %}
                            ${{ '%.0f' | format(p.price_low) }}
                        {% elif p.price_high %}
                            ${{ '%.0f' | format(p.price_high) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td class="px-2 py-3 text-center">
                        {% set color = 'bg-red-500/20 text-red-400' if p.score >= 70
                                       else 'bg-yellow-500/20 text-yellow-400' if p.score >= 40
                                       else 'bg-green-500/20 text-green-400' if p.score >= 15
                                       else 'bg-gray-700/50 text-gray-400' %}
                        <span class="score-badge {{ color }}">{{ '%.1f' | format(p.score) }}</span>
                    </td>
                    <td class="px-2 py-3 text-center">
                        {% if p.sparkline | length >= 2 %}
                            {% set scores = p.sparkline %}
                            {% set min_s = scores | min %}
                            {% set max_s = scores | max %}
                            {% set range_s = max_s - min_s if max_s != min_s else 1 %}
                            {% set line_color = '#22c55e' if scores[-1] > scores[0] else '#ef4444' if scores[-1] < scores[0] else '#6b7280' %}
                            <svg width="48" height="20" viewBox="0 0 {{ (scores | length - 1) * 10 }} 20" class="inline-block">
                                <polyline
                                    fill="none"
                                    stroke="{{ line_color }}"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    points="{% for s in scores %}{{ loop.index0 * 10 }},{{ 18 - ((s - min_s) / range_s * 16) + 1 }}{% if not loop.last %} {% endif %}{% endfor %}"
                                />
                            </svg>
                        {% else %}
                            <span class="text-gray-600">—</span>
                        {% endif %}
                    </td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.search_accel) }}</td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.social_velocity) }}</td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.amazon_accel) }}</td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.price_fit) }}</td>
                    <td class="px-2 py-3 text-center">
                        {% set s_val = p.sentiment %}
                        {% set s_color = 'text-green-400' if s_val >= 60
                                         else 'text-red-400' if s_val <= 40
                                         else 'text-gray-400' %}
                        <span class="{{ s_color }}">{{ '%.0f' | format(s_val) }}</span>
                    </td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.purchase_intent) }}</td>
                    <td class="px-2 py-3 text-center">
                        <span class="font-mono text-gray-300">{{ p.platform_count }}</span>
                    </td>
                    <td class="px-2 py-3 text-right text-gray-500 text-xs">
                        {% if p.first_seen %}{{ p.first_seen.strftime('%b %d') }}{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500 text-sm mt-2">No confirmed products in this view.</p>
    {% endif %}
</details>

<!-- Section 2: Social Signals (collapsed by default) -->
<details class="mt-6">
    <summary class="cursor-pointer text-gray-400 text-sm font-medium mb-2 select-none">
        Social Signals ({{ social | length }})
    </summary>
    {% if social %}
    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden mt-2">
        <table class="w-full text-sm table-fixed">
            <thead>
                <tr class="border-b border-gray-800 text-gray-400 text-xs uppercase tracking-wider">
                    <th class="w-8  px-2 py-3 text-left">#</th>
                    <th class="      px-2 py-3 text-left">Product</th>
                    <th class="w-24 px-2 py-3 text-left">Platform</th>
                    <th class="w-14 px-2 py-3 text-center">Score</th>
                    <th class="w-16 px-2 py-3 text-center">Trend</th>
                    <th class="w-12 px-2 py-3 text-center" title="Search acceleration">Srch</th>
                    <th class="w-12 px-2 py-3 text-center">Social</th>
                    <th class="w-12 px-2 py-3 text-center" title="Amazon BSR acceleration">Amzn</th>
                    <th class="w-14 px-2 py-3 text-center" title="Price fit score">P.Fit</th>
                    <th class="w-12 px-2 py-3 text-center" title="Sentiment score">Sent</th>
                    <th class="w-12 px-2 py-3 text-center" title="Purchase intent">Intent</th>
                    <th class="w-10 px-2 py-3 text-center" title="Platform source count">Src</th>
                    <th class="w-14 px-2 py-3 text-right" title="First seen date">Seen</th>
                </tr>
            </thead>
            <tbody>
                {% for p in social %}
                <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition-colors">
                    <td class="px-2 py-3 text-gray-500 font-mono">{{ loop.index }}</td>
                    <td class="px-2 py-3 min-w-0">
                        <a href="/products/{{ p.id }}" class="text-blue-400 hover:text-blue-300 font-medium line-clamp-2">
                            {{ p.name | title }}
                        </a>
                    </td>
                    <td class="px-2 py-3">
                        {% if p.sources %}
                        <div class="flex flex-wrap gap-1">
                            {% for src in p.sources[:2] %}
                            <span class="text-xs font-medium px-1.5 py-0.5 rounded
                                {% if src == 'tiktok' %}bg-pink-500/20 text-pink-400
                                {% elif src == 'reddit' %}bg-orange-500/20 text-orange-400
                                {% elif src == 'google_trends' %}bg-blue-500/20 text-blue-400
                                {% elif src == 'amazon' %}bg-yellow-500/20 text-yellow-400
                                {% elif src == 'etsy' %}bg-purple-500/20 text-purple-400
                                {% else %}bg-gray-700 text-gray-400{% endif %}">
                                {{ src | replace('google_trends', 'google') | replace('_', ' ') | title }}
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="text-gray-400 text-xs bg-gray-800 px-1.5 py-0.5 rounded block truncate">
                            {{ p.category | replace('-', ' ') | title if p.category else '—' }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-2 py-3 text-center">
                        {% set color = 'bg-red-500/20 text-red-400' if p.score >= 70
                                       else 'bg-yellow-500/20 text-yellow-400' if p.score >= 40
                                       else 'bg-green-500/20 text-green-400' if p.score >= 15
                                       else 'bg-gray-700/50 text-gray-400' %}
                        <span class="score-badge {{ color }}">{{ '%.1f' | format(p.score) }}</span>
                    </td>
                    <td class="px-2 py-3 text-center">
                        {% if p.sparkline | length >= 2 %}
                            {% set scores = p.sparkline %}
                            {% set min_s = scores | min %}
                            {% set max_s = scores | max %}
                            {% set range_s = max_s - min_s if max_s != min_s else 1 %}
                            {% set line_color = '#22c55e' if scores[-1] > scores[0] else '#ef4444' if scores[-1] < scores[0] else '#6b7280' %}
                            <svg width="48" height="20" viewBox="0 0 {{ (scores | length - 1) * 10 }} 20" class="inline-block">
                                <polyline
                                    fill="none"
                                    stroke="{{ line_color }}"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    points="{% for s in scores %}{{ loop.index0 * 10 }},{{ 18 - ((s - min_s) / range_s * 16) + 1 }}{% if not loop.last %} {% endif %}{% endfor %}"
                                />
                            </svg>
                        {% else %}
                            <span class="text-gray-600">—</span>
                        {% endif %}
                    </td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.search_accel) }}</td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.social_velocity) }}</td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.amazon_accel) }}</td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.price_fit) }}</td>
                    <td class="px-2 py-3 text-center">
                        {% set s_val = p.sentiment %}
                        {% set s_color = 'text-green-400' if s_val >= 60
                                         else 'text-red-400' if s_val <= 40
                                         else 'text-gray-400' %}
                        <span class="{{ s_color }}">{{ '%.0f' | format(s_val) }}</span>
                    </td>
                    <td class="px-2 py-3 text-center text-gray-300">{{ '%.1f' | format(p.purchase_intent) }}</td>
                    <td class="px-2 py-3 text-center">
                        <span class="font-mono text-gray-300">{{ p.platform_count }}</span>
                    </td>
                    <td class="px-2 py-3 text-right text-gray-500 text-xs">
                        {% if p.first_seen %}{{ p.first_seen.strftime('%b %d') }}{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500 text-sm mt-2">No social signals in this view.</p>
    {% endif %}
</details>

{% else %}
<div class="bg-gray-900 border border-gray-800 rounded-xl p-12 text-center">
    <p class="text-gray-400 text-lg mb-4">No products scored yet.</p>
    <p class="text-gray-500 text-sm mb-6">
        Click "Collect Now" to run the first data collection and scoring cycle.
    </p>
    <button onclick="triggerCollection()"
            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-medium transition-colors">
        Run First Collection
    </button>
</div>
{% endif %}

<script>
async function triggerCollection() {
    const btn = document.getElementById('triggerBtn');
    btn.disabled = true;
    btn.textContent = 'Collecting...';
    btn.classList.add('opacity-50');
    try {
        const resp = await fetch('/api/collect/trigger', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
            btn.textContent = `Done! (${data.scored} scored)`;
            setTimeout(() => location.reload(), 1500);
        } else {
            btn.textContent = 'Error';
            alert(data.detail || 'Collection failed');
        }
    } catch (e) {
        btn.textContent = 'Error';
        alert('Request failed: ' + e.message);
    } finally {
        setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'Collect Now';
            btn.classList.remove('opacity-50');
        }, 3000);
    }
}
</script>
{% endblock %}
